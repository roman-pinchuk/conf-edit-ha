# GEMINI.md - Context & Instructions

## Project Overview

**Project Name:** Home Assistant Configuration Editor (`conf-edit-ha`)

**Description:**
A lightweight Home Assistant add-on that provides a web-based text editor for configuration files. It features YAML syntax highlighting, entity autocomplete, and a VS Code-style file tree. It is designed to be a smaller, faster alternative to the VS Code add-on for simple editing tasks.

**Core Features:**
*   **Editor:** CodeMirror 6 with YAML support.
*   **Autocomplete:** Entity ID suggestions fetched from Home Assistant.
*   **Security:** File operations restricted to the `/config` directory; auto-backups on save.
*   **Architecture:** Multi-arch support (amd64, aarch64, armv7, etc.) via Docker.
*   **Integration:** Runs via Home Assistant Ingress.

## Tech Stack

*   **Backend:** Python 3.11 + Flask
*   **Frontend:** TypeScript + Vite + CodeMirror 6 (Vanilla TS, no framework like React/Vue)
*   **Container:** Alpine Linux based (via Home Assistant base images)
*   **Styling:** CSS Variables (VS Code-like dark/light themes)

## Directory Structure

```text
/
├── app.py              # Main Flask application entry point
├── config.yaml         # Home Assistant Add-on configuration (metadata, options)
├── build.yaml          # Multi-architecture build configuration
├── Dockerfile          # Docker container definition
├── requirements.txt    # Python backend dependencies
├── Makefile            # Command shortcuts for build/run
├── frontend/           # Frontend source code
│   ├── src/
│   │   ├── main.ts     # Frontend entry point
│   │   ├── editor.ts   # CodeMirror configuration
│   │   ├── api.ts      # API client for backend communication
│   │   ├── autocomplete.ts # Entity autocomplete logic
│   │   └── theme.ts    # Theme handling
│   ├── vite.config.ts  # Vite build config
│   └── package.json    # Frontend dependencies and scripts
├── static/             # compiled frontend assets (generated by build)
└── test-config/        # Mock configuration directory for local testing
```

## Build & Run Instructions

### Prerequisites
*   Docker
*   Node.js & npm
*   Python 3 (for local backend testing)

### Quick Commands (via Makefile)

*   **Build & Run:** `make build run`
*   **Build Frontend:** `make build-frontend`
*   **Build Docker:** `make build-docker`
*   **Run Container:** `make run`
*   **View Logs:** `make logs`

### Manual Development Workflow

1.  **Frontend Development:**
    ```bash
    cd frontend
    npm install
    npm run dev  # Starts dev server on http://localhost:3000
    ```

2.  **Backend/Integration Testing:**
    *   **Local Python:**
        ```bash
        pip install -r requirements.txt
        python app.py
        ```
    *   **Docker:**
        ```bash
        # Ensure frontend is built first
        cd frontend && npm run build && cd ..
        docker build -t conf-edit-ha .
        docker run -d -p 8099:8099 -v "$(pwd)/test-config:/config" conf-edit-ha
        ```

## Development Conventions

*   **Code Style:**
    *   **Python:** Follow PEP 8.
    *   **TypeScript:** Standard TypeScript conventions. Prefer strict typing.
*   **Architecture:**
    *   Keep the frontend lightweight (no heavy frameworks).
    *   The backend acts as a proxy to the HA API and a secure file manager.
    *   **Security First:** Always validate file paths to prevent directory traversal out of `/config`.
*   **Versioning:** Update `version` in `config.yaml` for releases.
*   **Testing:** Use `test-config` directory to simulate a Home Assistant environment locally.

## Key Configuration Files

*   **`config.yaml`:** Defines add-on metadata (name, version, slug) and user options (theme).
*   **`build.yaml`:** Maps architectures (amd64, aarch64) to base images.
*   **`frontend/vite.config.ts`:** Configures build output to `../static` for Flask to serve.
